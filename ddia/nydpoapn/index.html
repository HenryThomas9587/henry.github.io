<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.19" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><title>第10章 一致性与共识 | My Vuepress Site</title><meta name="description" content=""><link rel="preload" href="/henry.github.io/assets/style-iCC0LYON.css" as="style"><link rel="stylesheet" href="/henry.github.io/assets/style-iCC0LYON.css"><link rel="modulepreload" href="/henry.github.io/assets/app-BNwF3TyR.js"><link rel="modulepreload" href="/henry.github.io/assets/index.html-CA4AJJlP.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-6b855051><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-6665853b></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-6665853b> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-6b855051 data-v-b27f9974><div class="vp-navbar" vp-navbar data-v-b27f9974 data-v-bd857425><div class="wrapper" data-v-bd857425><div class="container" data-v-bd857425><div class="title" data-v-bd857425><div class="vp-navbar-title has-sidebar" data-v-bd857425 data-v-2ef7f17a><a class="vp-link no-icon link title" href="/henry.github.io/" data-v-2ef7f17a data-v-87b5717a><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" src="https://theme-plume.vuejs.press/plume.png" alt data-v-e3c54c70><!--]--><!--[--><img class="vp-image light logo" src="https://theme-plume.vuejs.press/plume.png" alt data-v-e3c54c70><!--]--><!--]--><!--]--><span data-v-2ef7f17a>My Vuepress Site</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-bd857425><div class="content-body" data-v-bd857425><!--[--><!--]--><div class="vp-navbar-search search" data-v-bd857425><div class="search-wrapper" data-v-42ff2bf3><!----><div id="local-search" data-v-42ff2bf3><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-42ff2bf3><span class="mini-search-button-container"><svg class="mini-search-search-icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-bd857425 data-v-6d8fb5f6><span id="main-nav-aria-label" class="visually-hidden" data-v-6d8fb5f6>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/henry.github.io/" tabindex="0" data-v-6d8fb5f6 data-v-ac70cb14 data-v-87b5717a><!--[--><!----><span data-v-ac70cb14>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/henry.github.io/blog/" tabindex="0" data-v-6d8fb5f6 data-v-ac70cb14 data-v-87b5717a><!--[--><!----><span data-v-ac70cb14>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/henry.github.io/blog/tags/" tabindex="0" data-v-6d8fb5f6 data-v-ac70cb14 data-v-87b5717a><!--[--><!----><span data-v-ac70cb14>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/henry.github.io/blog/archives/" tabindex="0" data-v-6d8fb5f6 data-v-ac70cb14 data-v-87b5717a><!--[--><!----><span data-v-ac70cb14>归档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-6d8fb5f6 data-v-f5157cbd><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-f5157cbd><span class="text" data-v-f5157cbd><!----><!----><span data-v-f5157cbd>笔记</span><span class="vpi-chevron-down text-icon" data-v-f5157cbd></span></span></button><div class="menu" data-v-f5157cbd><div class="vp-menu" data-v-f5157cbd data-v-22b26cbd><div class="items" data-v-22b26cbd><!--[--><!--[--><div class="vp-menu-link" data-v-22b26cbd data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/android/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> Android<!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-22b26cbd data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/ddia/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> DDIA 学习笔记<!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-22b26cbd data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/demo/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> Demo<!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-22b26cbd data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/flutter/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> Flutter<!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-22b26cbd data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/ui/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> Ui<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><div class="vp-flyout vp-navbar-translations translations" data-v-bd857425 data-v-0ffcc6de data-v-f5157cbd><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="选择语言" data-v-f5157cbd><span class="text" data-v-f5157cbd><!----><span class="vpi-languages option-icon" data-v-f5157cbd></span><!----><span class="vpi-chevron-down text-icon" data-v-f5157cbd></span></span></button><div class="menu" data-v-f5157cbd><div class="vp-menu" data-v-f5157cbd data-v-22b26cbd><!----><!--[--><!--[--><div class="items" data-v-0ffcc6de><p class="title" data-v-0ffcc6de>简体中文</p><!--[--><div class="vp-menu-link" data-v-0ffcc6de data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/en/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> English<!--]--><!----></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="vp-navbar-appearance appearance" data-v-bd857425 data-v-d9c55eda><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-d9c55eda data-v-ad1b2bdf data-v-61405998><span class="check" data-v-61405998><span class="icon" data-v-61405998><!--[--><span class="vpi-sun sun" data-v-ad1b2bdf></span><span class="vpi-moon moon" data-v-ad1b2bdf></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-bd857425 data-v-26cdeb54 data-v-03411773><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-03411773 data-v-4463c1f8><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-bd857425 data-v-ff262915 data-v-f5157cbd><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-f5157cbd><span class="vpi-more-horizontal icon" data-v-f5157cbd></span></button><div class="menu" data-v-f5157cbd><div class="vp-menu" data-v-f5157cbd data-v-22b26cbd><!----><!--[--><!--[--><div class="group translations" data-v-ff262915><p class="trans-title" data-v-ff262915>简体中文</p><!--[--><div class="vp-menu-link" data-v-ff262915 data-v-d5eb0fee><a class="vp-link no-icon link" href="/henry.github.io/en/" data-v-d5eb0fee data-v-87b5717a><!--[--><!----> English<!--]--><!----></a></div><!--]--></div><div class="group" data-v-ff262915><div class="item appearance" data-v-ff262915><p class="label" data-v-ff262915>外观</p><div class="appearance-action" data-v-ff262915><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-ff262915 data-v-ad1b2bdf data-v-61405998><span class="check" data-v-61405998><span class="icon" data-v-61405998><!--[--><span class="vpi-sun sun" data-v-ad1b2bdf></span><span class="vpi-moon moon" data-v-ad1b2bdf></span><!--]--></span></span></button></div></div></div><div class="group" data-v-ff262915><div class="item social-links" data-v-ff262915><div class="vp-social-links social-links-list" data-v-ff262915 data-v-03411773><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-03411773 data-v-4463c1f8><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-bd857425 data-v-bc2fdff4><span class="container" data-v-bc2fdff4><span class="top" data-v-bc2fdff4></span><span class="middle" data-v-bc2fdff4></span><span class="bottom" data-v-bc2fdff4></span></span></button></div></div></div></div><div class="divider" data-v-bd857425><div class="divider-line" data-v-bd857425></div></div></div><!----></header><div class="vp-local-nav reached-top is-blog" data-v-6b855051 data-v-a9fbedc4><button class="menu" aria-expanded="false" aria-controls="SidebarNav" data-v-a9fbedc4><span class="vpi-align-left menu-icon" data-v-a9fbedc4></span><span class="menu-text" data-v-a9fbedc4>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-a9fbedc4 data-v-efb9a031><button data-v-efb9a031>返回顶部</button><!----></div></div><aside class="vp-sidebar" vp-sidebar data-v-6b855051 data-v-e8b1f427><div class="curtain" data-v-e8b1f427></div><nav id="SidebarNav" class="nav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-e8b1f427><span id="sidebar-aria-label" class="visually-hidden" data-v-e8b1f427> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c7d7fce2><section class="vp-sidebar-item sidebar-item level-0 collapsible is-link" data-v-c7d7fce2 data-v-13ba94ca><div class="item" tabindex="0" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/7x9vynpy/" data-v-13ba94ca data-v-87b5717a><!--[--><h2 class="text" data-v-13ba94ca>part1-foundations</h2><!--]--><!----></a><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-13ba94ca><span class="vpi-chevron-right caret-icon" data-v-13ba94ca></span></div></div><div class="items" data-v-13ba94ca><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/670y7cuq/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第1章 可靠性、可扩展性与可维护性</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/ia4ww5f0/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第2章 定义非功能性需求</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/vva8j2cd/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第3章 数据模型与查询语言</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/qoji05j0/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第4章 存储与检索</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/dxwd3178/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第5章 编码与演化</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c7d7fce2><section class="vp-sidebar-item sidebar-item level-0 collapsible is-link has-active" data-v-c7d7fce2 data-v-13ba94ca><div class="item" tabindex="0" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/499k0udf/" data-v-13ba94ca data-v-87b5717a><!--[--><h2 class="text" data-v-13ba94ca>part2-distributed</h2><!--]--><!----></a><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-13ba94ca><span class="vpi-chevron-right caret-icon" data-v-13ba94ca></span></div></div><div class="items" data-v-13ba94ca><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/part2-distributed/chapter-06/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第6章 复制</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/bxqsc20o/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第7章 分区</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/fm1ruuoh/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第8章 事务</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/cpolrctq/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第9章 分布式系统的麻烦</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-13ba94ca data-v-13ba94ca><div class="item" data-v-13ba94ca><div class="indicator" data-v-13ba94ca></div><!----><a class="vp-link no-icon link link" href="/henry.github.io/ddia/nydpoapn/" data-v-13ba94ca data-v-87b5717a><!--[--><p class="text" data-v-13ba94ca>第10章 一致性与共识</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><!--[--><div id="VPContent" vp-content class="vp-content has-sidebar" data-v-6b855051 data-v-6d75db73><div class="has-sidebar has-aside vp-doc-container" data-v-94616537><!--[--><!--]--><div class="container" data-v-94616537><div class="aside" vp-outline data-v-94616537><div class="aside-curtain" data-v-94616537></div><div class="aside-container" data-v-94616537><div class="aside-content" data-v-94616537><div class="vp-doc-aside" data-v-94616537 data-v-c5a5865a><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="vp-doc-aside-outline" role="navigation" data-v-c5a5865a data-v-2d954bbe><div class="content" data-v-2d954bbe><div class="outline-marker" data-v-2d954bbe></div><div id="doc-outline-aria-label" aria-level="2" class="outline-title" role="heading" data-v-2d954bbe><span data-v-2d954bbe>此页内容</span><span class="vpi-print icon" data-v-2d954bbe></span></div><ul class="root" data-v-2d954bbe data-v-a404a7d7><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-c5a5865a></div><!--[--><!--]--></div></div></div></div><div class="content" data-v-94616537><div class="content-container" data-v-94616537><!--[--><!--]--><main class="main" data-v-94616537><nav class="vp-breadcrumb" data-v-94616537 data-v-5efe8592><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-5efe8592><!--[--><li property="itemListElement" typeof="ListItem" data-v-5efe8592><a class="vp-link no-icon link breadcrumb" href="/henry.github.io/" property="item" typeof="WebPage" data-v-5efe8592 data-v-87b5717a><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-5efe8592></span><meta property="name" content="首页" data-v-5efe8592><meta property="position" content="1" data-v-5efe8592></li><li property="itemListElement" typeof="ListItem" data-v-5efe8592><a class="vp-link no-icon link breadcrumb" href="/henry.github.io/ddia/499k0udf/" property="item" typeof="WebPage" data-v-5efe8592 data-v-87b5717a><!--[-->part2-distributed<!--]--><!----></a><span class="vpi-chevron-right" data-v-5efe8592></span><meta property="name" content="part2-distributed" data-v-5efe8592><meta property="position" content="2" data-v-5efe8592></li><li property="itemListElement" typeof="ListItem" data-v-5efe8592><a class="vp-link no-icon link breadcrumb current" href="/henry.github.io/ddia/nydpoapn/" property="item" typeof="WebPage" data-v-5efe8592 data-v-87b5717a><!--[-->第10章 一致性与共识<!--]--><!----></a><!----><meta property="name" content="第10章 一致性与共识" data-v-5efe8592><meta property="position" content="3" data-v-5efe8592></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-349c6f6c>第10章 一致性与共识 <!----></h1><div class="vp-doc-meta" data-v-349c6f6c><p class="reading-time" data-v-349c6f6c><span class="vpi-books icon" data-v-349c6f6c></span><span data-v-349c6f6c>约 2958 字</span><span data-v-349c6f6c>大约 10 分钟</span></p><!----><p class="create-time" data-v-349c6f6c><span class="vpi-clock icon" data-v-349c6f6c></span><span data-v-349c6f6c>2025-12-26</span></p></div><!--]--><div class="_ddia_nydpoapn_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-94616537><div data-v-94616537><h2 id="章节概览" tabindex="-1"><a class="header-anchor" href="#章节概览"><span>章节概览</span></a></h2><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><p>本章探讨分布式系统中的强一致性保证和共识算法，这是构建容错分布式系统的理论基础。主要内容包括：</p><ul><li><strong>线性一致性（Linearizability）</strong>：最强的一致性模型，使分布式系统表现得像单机系统</li><li><strong>因果一致性（Causal Consistency）</strong>：通过逻辑时钟实现的弱化一致性模型</li><li><strong>全序广播（Total Order Broadcast）</strong>：保证消息有序传递的通信原语</li><li><strong>共识算法（Consensus Algorithms）</strong>：Paxos、Raft、Zab 等经典算法</li><li><strong>分布式事务</strong>：基于共识的原子提交协议</li></ul><h2 id="一致性模型" tabindex="-1"><a class="header-anchor" href="#一致性模型"><span>一致性模型</span></a></h2><h3 id="线性一致性-linearizability" tabindex="-1"><a class="header-anchor" href="#线性一致性-linearizability"><span>线性一致性（Linearizability）</span></a></h3><p><strong>定义</strong>：线性一致性使复制系统表现得像只有一份数据副本，所有操作都原子性地作用于这份数据。</p><p><strong>核心特性</strong>：</p><ol><li><strong>唯一性（Uniqueness）</strong>：每个操作看起来在其开始和结束之间的某个时间点生效</li><li><strong>顺序性（Ordering）</strong>：如果操作 A 在操作 B 开始前完成，则 B 必须看到 A 的效果</li><li><strong>原子性（Atomicity）</strong>：从外部观察者角度，操作是瞬时完成的</li></ol><p><strong>新鲜性保证</strong>：一旦写操作完成，所有后续读操作必须返回该值或更新的值。</p><p><strong>典型应用场景</strong>：</p><ul><li><strong>领导者选举和锁服务</strong>：防止脑裂（split-brain）场景</li><li><strong>唯一性约束</strong>：确保用户名、文件路径等全局唯一</li><li><strong>跨通道时序依赖</strong>：协调不同通信渠道之间的操作</li></ul><p><strong>实现挑战</strong>：</p><table><thead><tr><th>复制方式</th><th>线性一致性</th><th>说明</th></tr></thead><tbody><tr><td>单主复制</td><td>可能支持</td><td>需要仔细处理故障切换，避免脑裂</td></tr><tr><td>多主复制</td><td>不支持</td><td>并发写入导致冲突，无法保证全局顺序</td></tr><tr><td>无主复制（Quorum）</td><td>不一定支持</td><td>网络延迟可能导致读到旧值</td></tr></tbody></table><h3 id="因果一致性-causal-consistency" tabindex="-1"><a class="header-anchor" href="#因果一致性-causal-consistency"><span>因果一致性（Causal Consistency）</span></a></h3><p>因果一致性是比线性一致性更弱但更高效的一致性模型，只保证有因果关系的操作按顺序执行。</p><p><strong>优势</strong>：</p><ul><li>不需要全局协调</li><li>性能开销更小</li><li>可以在分区时继续工作</li></ul><h2 id="逻辑时钟与-id-生成" tabindex="-1"><a class="header-anchor" href="#逻辑时钟与-id-生成"><span>逻辑时钟与 ID 生成</span></a></h2><h3 id="lamport-时间戳" tabindex="-1"><a class="header-anchor" href="#lamport-时间戳"><span>Lamport 时间戳</span></a></h3><p><strong>原理</strong>：在不依赖物理时钟同步的情况下提供因果顺序。</p><p><strong>实现机制</strong>：</p><ul><li>每个节点维护一个计数器和唯一 ID</li><li>时间戳格式：<code>(counter, node_id)</code></li><li>计数器在事件发生时递增</li><li>接收消息时，将计数器更新为 <code>max(local_counter, received_counter) + 1</code></li></ul><p><strong>特点</strong>：</p><ul><li>提供全序关系（total ordering）</li><li>无法区分并发事件</li><li>不能反向推导因果关系</li></ul><h3 id="混合逻辑时钟-hybrid-logical-clocks" tabindex="-1"><a class="header-anchor" href="#混合逻辑时钟-hybrid-logical-clocks"><span>混合逻辑时钟（Hybrid Logical Clocks）</span></a></h3><p>结合物理时间和逻辑排序的优点：</p><ul><li>像物理时钟一样跟踪经过的时间</li><li>像 Lamport 时钟一样维护因果一致性</li><li>最小化与物理时间的偏差</li></ul><h3 id="线性一致的-id-生成器" tabindex="-1"><a class="header-anchor" href="#线性一致的-id-生成器"><span>线性一致的 ID 生成器</span></a></h3><p><strong>实现方式</strong>：</p><ol><li><strong>单节点生成器</strong>：使用原子递增操作</li><li><strong>批量分配</strong>：预分配 ID 范围以提高性能</li><li><strong>基于共识的分布式生成</strong>：使用共识算法协调 ID 分配</li></ol><h2 id="共识算法" tabindex="-1"><a class="header-anchor" href="#共识算法"><span>共识算法</span></a></h2><h3 id="共识问题定义" tabindex="-1"><a class="header-anchor" href="#共识问题定义"><span>共识问题定义</span></a></h3><p>共识解决了让分布式节点就单个值达成一致的基本问题，同时容忍节点故障。</p><p><strong>必须满足的属性</strong>：</p><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>Agreement（一致性）</td><td>没有两个节点做出不同的决定</td></tr><tr><td>Integrity（完整性）</td><td>节点不能改变已做出的决定</td></tr><tr><td>Validity（有效性）</td><td>决定的值必须是某个节点提议的</td></tr><tr><td>Termination（终止性）</td><td>未崩溃的节点最终会做出决定</td></tr></tbody></table><h3 id="等价问题" tabindex="-1"><a class="header-anchor" href="#等价问题"><span>等价问题</span></a></h3><p>以下问题都可以归约为共识问题：</p><ul><li>线性一致的 compare-and-set 操作</li><li>分布式事务中的原子提交</li><li>全序广播（共享日志）</li><li>领导者选举和分布式锁</li></ul><h3 id="主流共识算法" tabindex="-1"><a class="header-anchor" href="#主流共识算法"><span>主流共识算法</span></a></h3><h4 id="raft" tabindex="-1"><a class="header-anchor" href="#raft"><span>Raft</span></a></h4><p><strong>特点</strong>：</p><ul><li>设计目标是易于理解</li><li>使用任期号（term number）进行领导者选举</li><li>强领导者模型（strong leader）</li></ul><p><strong>工作流程</strong>：</p><ol><li><strong>领导者选举</strong>：节点超时后发起选举，获得多数票成为领导者</li><li><strong>日志复制</strong>：领导者接收客户端请求，复制到多数节点</li><li><strong>安全性保证</strong>：只有包含所有已提交日志的节点才能成为领导者</li></ol><h4 id="paxos-multi-paxos" tabindex="-1"><a class="header-anchor" href="#paxos-multi-paxos"><span>Paxos / Multi-Paxos</span></a></h4><p><strong>特点</strong>：</p><ul><li>经典共识算法，理论基础</li><li>使用提案号（proposal number）</li><li>Multi-Paxos 优化了连续决策的性能</li></ul><p><strong>阶段</strong>：</p><ol><li><strong>准备阶段（Prepare）</strong>：提议者发送提案号，获取承诺</li><li><strong>接受阶段（Accept）</strong>：提议者发送值，获取多数接受</li></ol><h4 id="zab-zookeeper-atomic-broadcast" tabindex="-1"><a class="header-anchor" href="#zab-zookeeper-atomic-broadcast"><span>Zab（ZooKeeper Atomic Broadcast）</span></a></h4><p><strong>特点</strong>：</p><ul><li>用于 ZooKeeper 协调服务</li><li>保证全序广播</li><li>支持崩溃恢复</li></ul><p><strong>核心机制</strong>：</p><ul><li>使用 epoch 号标识领导者任期</li><li>两阶段提交协议</li><li>同步阶段确保新领导者拥有最新状态</li></ul><h3 id="共识算法通用模式" tabindex="-1"><a class="header-anchor" href="#共识算法通用模式"><span>共识算法通用模式</span></a></h3><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><h2 id="状态机复制-state-machine-replication" tabindex="-1"><a class="header-anchor" href="#状态机复制-state-machine-replication"><span>状态机复制（State Machine Replication）</span></a></h2><p><strong>原理</strong>：共识算法使得状态机复制成为可能。</p><p><strong>工作机制</strong>：</p><ul><li>所有副本以相同顺序处理相同操作</li><li>确定性状态机保持一致</li><li>支持可序列化事务和事件溯源</li></ul><p><strong>应用</strong>：</p><ul><li>分布式数据库</li><li>分布式配置管理</li><li>分布式队列和消息系统</li></ul><h2 id="全序广播-total-order-broadcast" tabindex="-1"><a class="header-anchor" href="#全序广播-total-order-broadcast"><span>全序广播（Total Order Broadcast）</span></a></h2><p><strong>定义</strong>：保证所有节点以相同顺序接收消息的通信原语。</p><p><strong>与共识的关系</strong>：</p><ul><li>全序广播等价于重复的共识</li><li>每条消息相当于一轮共识</li><li>共识可以通过全序广播实现</li></ul><p><strong>实现方式</strong>：</p><ul><li>使用共识算法对消息排序</li><li>领导者负责分配序列号</li><li>日志复制确保顺序一致</li></ul><h2 id="分布式事务与原子提交" tabindex="-1"><a class="header-anchor" href="#分布式事务与原子提交"><span>分布式事务与原子提交</span></a></h2><h3 id="两阶段提交-2pc" tabindex="-1"><a class="header-anchor" href="#两阶段提交-2pc"><span>两阶段提交（2PC）</span></a></h3><p><strong>角色</strong>：</p><ul><li><strong>协调者（Coordinator）</strong>：管理事务提交流程</li><li><strong>参与者（Participants）</strong>：执行事务操作的节点</li></ul><p><strong>阶段</strong>：</p><ol><li><p><strong>准备阶段（Prepare Phase）</strong></p><ul><li>协调者向所有参与者发送准备请求</li><li>参与者执行事务，写入日志，返回投票（Yes/No）</li></ul></li><li><p><strong>提交阶段（Commit Phase）</strong></p><ul><li>如果所有参与者投 Yes，协调者发送提交命令</li><li>如果任何参与者投 No，协调者发送中止命令</li><li>参与者执行命令并返回确认</li></ul></li></ol><p><strong>问题</strong>：</p><ul><li>协调者单点故障会导致参与者阻塞</li><li>需要持久化日志以支持崩溃恢复</li><li>性能开销较大</li></ul><h3 id="三阶段提交-3pc" tabindex="-1"><a class="header-anchor" href="#三阶段提交-3pc"><span>三阶段提交（3PC）</span></a></h3><p>在 2PC 基础上增加超时机制，减少阻塞，但仍无法完全解决网络分区问题。</p><h2 id="权衡与限制" tabindex="-1"><a class="header-anchor" href="#权衡与限制"><span>权衡与限制</span></a></h2><h3 id="共识的代价" tabindex="-1"><a class="header-anchor" href="#共识的代价"><span>共识的代价</span></a></h3><table><thead><tr><th>方面</th><th>限制</th></tr></thead><tbody><tr><td>容错能力</td><td>需要严格多数才能运行（3 节点容忍 1 个故障）</td></tr><tr><td>可扩展性</td><td>无法通过增加节点提升吞吐量</td></tr><tr><td>网络敏感性</td><td>对网络分区和延迟变化敏感</td></tr><tr><td>地理分布</td><td>跨地域部署会增加协调开销</td></tr></tbody></table><h3 id="cap-定理的上下文" tabindex="-1"><a class="header-anchor" href="#cap-定理的上下文"><span>CAP 定理的上下文</span></a></h3><p>当网络分区发生时，系统必须在以下两者之间选择：</p><ul><li><strong>一致性（Consistency）</strong>：维护线性一致性但变得不可用</li><li><strong>可用性（Availability）</strong>：继续运行但失去线性一致性</li></ul><h3 id="性能影响" tabindex="-1"><a class="header-anchor" href="#性能影响"><span>性能影响</span></a></h3><p>线性一致性本质上需要协调，这使得它比最终一致性的替代方案更慢，特别是在跨地域场景下。</p><p><strong>优化策略</strong>：</p><ul><li>使用更弱的一致性模型（如因果一致性）</li><li>批量处理请求减少往返次数</li><li>使用租约（lease）减少协调频率</li></ul><h2 id="实际应用" tabindex="-1"><a class="header-anchor" href="#实际应用"><span>实际应用</span></a></h2><h3 id="协调服务" tabindex="-1"><a class="header-anchor" href="#协调服务"><span>协调服务</span></a></h3><table><thead><tr><th>系统</th><th>用途</th><th>共识算法</th></tr></thead><tbody><tr><td>ZooKeeper</td><td>分布式协调原语</td><td>Zab</td></tr><tr><td>etcd</td><td>键值存储，强一致性</td><td>Raft</td></tr><tr><td>Consul</td><td>服务发现，强一致性</td><td>Raft</td></tr></tbody></table><p><strong>提供的功能</strong>：</p><ul><li>领导者选举</li><li>分布式锁</li><li>配置管理</li><li>服务注册与发现</li></ul><h3 id="数据库系统" tabindex="-1"><a class="header-anchor" href="#数据库系统"><span>数据库系统</span></a></h3><p><strong>应用场景</strong>：</p><ul><li>单主数据库的自动故障切换</li><li>分布式数据库使用共识管理元数据</li><li>事务协调器实现原子提交</li></ul><p><strong>示例</strong>：</p><ul><li>Google Spanner：使用 Paxos 实现跨数据中心一致性</li><li>CockroachDB：使用 Raft 实现分布式 SQL</li><li>MongoDB：使用 Raft-like 协议进行副本集选举</li></ul><h2 id="核心理念" tabindex="-1"><a class="header-anchor" href="#核心理念"><span>核心理念</span></a></h2><p><strong>核心要点</strong>：</p><ol><li><strong>线性一致性</strong>是最强的一致性保证，但代价高昂</li><li><strong>共识算法</strong>是构建容错分布式系统的理论基础</li><li><strong>全序广播</strong>、<strong>原子提交</strong>、<strong>领导者选举</strong>本质上都是共识问题</li><li><strong>状态机复制</strong>通过共识实现强一致性</li><li><strong>CAP 定理</strong>说明分区时必须在一致性和可用性之间权衡</li><li>实际系统中，应根据需求选择合适的一致性级别</li></ol><p><strong>实践建议</strong>：</p><ul><li>不是所有场景都需要线性一致性，优先考虑更弱的一致性模型</li><li>使用成熟的协调服务（ZooKeeper、etcd）而非自己实现共识</li><li>理解共识的性能限制，避免在关键路径上过度使用</li><li>跨地域部署时，考虑使用多数据中心共识或最终一致性方案</li></ul></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-94616537 data-v-76964c65><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-76964c65><span class="contributors-label" data-v-76964c65>贡献者: </span><span class="contributors-info" data-v-76964c65><!--[--><!--[--><span class="contributor" data-v-76964c65>aidenreed937</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" data-v-76964c65>Claude Opus 4.5</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" data-v-76964c65>Claude Sonnet 4.5</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-76964c65><div class="pager" data-v-76964c65><a class="vp-link no-icon link pager-link prev" href="/henry.github.io/ddia/cpolrctq/" data-v-76964c65 data-v-87b5717a><!--[--><span class="desc" data-v-76964c65>上一页</span><span class="title" data-v-76964c65>第9章 分布式系统的麻烦</span><!--]--><!----></a></div><div class="pager" data-v-76964c65><!----></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-6b855051 style="display:none;" data-v-41e7b746><span class="percent" data-allow-mismatch data-v-41e7b746>0%</span><span class="show icon vpi-back-to-top" data-v-41e7b746></span><svg aria-hidden="true" data-v-41e7b746><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-41e7b746></circle></svg></button><footer class="vp-footer has-sidebar" vp-footer data-v-6b855051 data-v-5f4a75b0><!--[--><div class="container" data-v-5f4a75b0><p class="message" data-v-5f4a75b0>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/henry.github.io/assets/app-BNwF3TyR.js" defer></script></body></html>