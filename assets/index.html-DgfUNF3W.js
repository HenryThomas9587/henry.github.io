import{_ as l,c as t,b as e,a,d as n,r as h,o as p}from"./app-BNwF3TyR.js";const r={};function k(d,s){const i=h("Mermaid");return p(),t("div",null,[s[0]||(s[0]=e("h2",{id:"概述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#概述"},[e("span",null,"概述")])],-1)),s[1]||(s[1]=e("p",null,"Android 系统服务是 Framework 层的核心组成部分，为应用开发者提供了丰富的系统功能接口。这些系统服务运行在特权进程中（通常是 System Server 进程），通过 Binder IPC 机制向应用提供跨进程服务。系统服务是 Android 操作系统功能的实际实现者，管理着从界面显示到电源管理、从数据库访问到网络连接等各方面的功能。",-1)),s[2]||(s[2]=e("h2",{id:"系统服务架构",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#系统服务架构"},[e("span",null,"系统服务架构")])],-1)),s[3]||(s[3]=e("p",null,"Android 系统服务采用分层架构，主要分为客户端接口层和服务实现层：",-1)),a(i,{id:"mermaid-12",code:"eJxLL0osyFAIceFSAALH6Ke7pjyfsuL5iu6nu/pjFXR17Wqe7N0PFKlRcIp+um7Rs47tz1evf9a39Gn/4qcbm2LBupzA6pwy81JSixQ8A5xrFJyjn83pfdq18Om6ec/7NsAVOoMVvtjQDDbQBWjZVKDc012Tn07qebly49OuFRB1YKK4pDInVcFRIS0zJ8dK2dLA2dHNUqe4pCg/O9VK2dDUzNTZAMrVLc9MKcmwMiqoQNLoBNXo5uZqYGEE1+jmZuFmgFejM1Sjo6mLmaM5XKORq7mLMcwcrBpdoBqdXS2NXSzgGs0cDZ0sHTE1AgDmXY4M"}),s[4]||(s[4]=n('<h3 id="客户端接口层" tabindex="-1"><a class="header-anchor" href="#客户端接口层"><span>客户端接口层</span></a></h3><p>客户端接口层是面向应用开发者的 API，通常位于 <code>android.*</code> 包中，如：</p><ul><li><code>android.app.ActivityManager</code></li><li><code>android.view.WindowManager</code></li><li><code>android.content.pm.PackageManager</code></li></ul><h3 id="服务实现层" tabindex="-1"><a class="header-anchor" href="#服务实现层"><span>服务实现层</span></a></h3><p>服务实现层是系统服务的具体实现，通常位于 <code>com.android.server.*</code> 包中，如：</p><ul><li><code>com.android.server.am.ActivityManagerService</code></li><li><code>com.android.server.wm.WindowManagerService</code></li><li><code>com.android.server.pm.PackageManagerService</code></li></ul><h2 id="系统服务的分类" tabindex="-1"><a class="header-anchor" href="#系统服务的分类"><span>系统服务的分类</span></a></h2><p>Android 系统服务可以按照功能和启动时机进行分类。</p><h3 id="按功能分类" tabindex="-1"><a class="header-anchor" href="#按功能分类"><span>按功能分类</span></a></h3>',9)),a(i,{id:"mermaid-68",code:"eJx1UsFKQkEU3fcVb6mfYbUxMiIr1+O8W17SuTLOU9xFVIvIkDIIC0RoIUESSCCK9DNv3qu/aMwXNTZtz7n3zDlnbgWFX2HVFc+TRCqVyghfEvrxaBpPe9FDS1/002nDep6edOLOIB724/b5gviCPS/DFdZRNXNMsEOQeZB15JCQ24wfGdTJbZHCA+RMIQnHwF42vh/rs5H1WMH4pYZTLiuqgXIyGc6hVsMilt02F2nfX0+jSXsR8Ns9NUA6JVeZUiCbNriPRckUWaMfx93wrW9l2IUyVEsklrbXSAhIurSZgqnpNxLdvkStYTi+0s93+mRgiRsVBUL9KYAC4S5ng4p5XgI/KNuMfuzqp+twdmN/duAjLflmFZDMxnLgI9uhwHRkaQ674aw1N3450b3kvpKVTfr3EuapjH3ZXAdlGvop+BPglAy6"}),s[5]||(s[5]=n('<h3 id="按启动时机分类" tabindex="-1"><a class="header-anchor" href="#按启动时机分类"><span>按启动时机分类</span></a></h3><p>系统服务根据启动时机可以分为三类：</p><ol><li><strong>引导服务（Bootstrap Services）</strong>：系统启动早期阶段就需要运行的基础服务</li><li><strong>核心服务（Core Services）</strong>：系统核心功能相关的服务</li><li><strong>其他服务（Other Services）</strong>：在前两类服务启动后才启动的服务</li></ol><h2 id="重要系统服务详解" tabindex="-1"><a class="header-anchor" href="#重要系统服务详解"><span>重要系统服务详解</span></a></h2><h3 id="activitymanagerservice-ams" tabindex="-1"><a class="header-anchor" href="#activitymanagerservice-ams"><span>ActivityManagerService (AMS)</span></a></h3><p>ActivityManagerService 是 Android 系统中最核心的服务之一，负责管理应用程序的活动和生命周期。</p>',6)),a(i,{id:"mermaid-101",code:"eJxLL0osyFAIceFSAALH6Ke7pjyfsuL5iu6nu/pjFXR17WqeTlj/tGuFY3JJZllmSWWNglM0jO2bmJeYnloUC9bqBFbslJmXklqk4BngXKPgjK4wOLWoLDM5FaLeGaz++bqFzye01Si4wNU+W9CBTYEr1GUv9s8GOg5FxeyJz/qW1yi4RTv6BT1b3PBsK1QaTBSXVOakAlWmZebkWCm7ubkaWBjpFJcU5WengrgWbgYGUK5ueWZKSYaVUUEFFwAdHWm2"}),s[6]||(s[6]=n('<p><strong>主要功能</strong>：</p><ul><li>管理所有应用程序的 Activity 生命周期</li><li>处理应用程序的启动、切换和关闭</li><li>管理应用的任务栈（Task Stack）</li><li>监控应用 ANR（Application Not Responding）状态</li><li>管理进程优先级和内存回收</li></ul><h3 id="windowmanagerservice-wms" tabindex="-1"><a class="header-anchor" href="#windowmanagerservice-wms"><span>WindowManagerService (WMS)</span></a></h3><p>WindowManagerService 负责管理所有窗口的显示和布局。</p>',4)),a(i,{id:"mermaid-138",code:"eJxLL0osyFAIceFSAALH6Ke7pjyfsuL5iu6nu/pjFXR17Wqer5r+tH/xs8m9T/bOqVFwig7PzEvJL/dNzEtMTy2KBWtzAit0AkqkFil4BjjXKDijKgtOLSrLTE6FqHYGq37a2/9iQ3ONgkt0cGlRWmJyqltOZh7cRIia5+sWPp/QVqPgGg1xxNONTc93LUcxZUkLWIVb9It9k5+2Ln2yq/vJ7m0QFWCiuKQyJxWoOC0zJ8dK2c3N1cDCSKe4pCg/OxXEtXAzMIBydcszU0oyrIwKKpA0ukA1Opq6mDmawzUauZq7GMPMQdIIAM59fis="}),s[7]||(s[7]=n('<p><strong>主要功能</strong>：</p><ul><li>管理应用窗口的显示和叠加顺序</li><li>处理窗口的添加、移除和更新</li><li>协调输入事件的分发</li><li>与 SurfaceFlinger 配合完成界面渲染</li><li>实现屏幕旋转和多显示设备支持</li></ul><h3 id="packagemanagerservice-pms" tabindex="-1"><a class="header-anchor" href="#packagemanagerservice-pms"><span>PackageManagerService (PMS)</span></a></h3><p>PackageManagerService 负责管理所有应用程序包相关的信息。</p>',4)),a(i,{id:"mermaid-175",code:"eJxLL0osyFAIceFSAALH6Ke7pjyfsuL5iu6nu/pjFXR17Wqe9rQ+m7/0xfpFNQpO0QGJydmJ6am+iXlAsigWrMkJrMwpMy8ltUjBM8C5RsEZTV1walFZZnIqRLkzWPmL9buf9k+rUXCJdsxLKcrPTAEqzUxLLS7Rq8jNQVb4fN3C5xPaahRcoU57sn/hs8b1z6ZueNa77umuychKny5pASt1gyp9uq7zxeJW/ae9O17s3QtRCCaKSypzUoF60jJzcqyU3dxcDSyMdIpLivKzU0FcCzcDAyhXtzwzpSTDyqigggsAYCd4Dw=="}),s[8]||(s[8]=n('<p><strong>主要功能</strong>：</p><ul><li>管理应用的安装、卸载和更新</li><li>解析应用的 AndroidManifest.xml 文件</li><li>维护已安装应用的信息和权限</li><li>处理应用间的组件调用和权限检查</li><li>管理应用的签名验证</li></ul><h3 id="powermanagerservice" tabindex="-1"><a class="header-anchor" href="#powermanagerservice"><span>PowerManagerService</span></a></h3><p>PowerManagerService 负责管理设备的电源状态。</p>',4)),a(i,{id:"mermaid-212",code:"eJxLL0osyFAIceFSAALH6Ke7pjyfsuL5iu6nu/pjFXR17WqeT9n6bNeEZ5N7n+ydU6PgFB2QX55a5JuYl5ieWhQL1uUEVueUmZeSWqTgGeBco+CMoio4tagsMzkVotgZrPhZ3/KnHdtqFFyin27sf7pz6rMZ+54v2YWs4vm6hc8ntNUouEY/2TPx+ZwF+k+nLHnZNglFyeyJQHNqFNyiIW58OaURIg0miksqc1KBKtMyc3KslN3cXA0sjHSKS4rys1NBXAs3AwMoV7c8M6Ukw8qooIILAAOKbRc="}),s[9]||(s[9]=n('<p><strong>主要功能</strong>：</p><ul><li>管理设备的电源状态</li><li>控制屏幕点亮和熄灭</li><li>处理休眠和唤醒</li><li>管理电源相关的锁（WakeLock）</li><li>实现电源按键行为</li></ul><h2 id="系统服务的启动流程" tabindex="-1"><a class="header-anchor" href="#系统服务的启动流程"><span>系统服务的启动流程</span></a></h2><p>Android 系统服务的启动流程遵循一定的顺序，确保各服务之间的依赖关系得到满足。</p>',4)),a(i,{id:"mermaid-249",code:"eJyNks9Kw0AQxu8+xR4VbEG95VCwevQfFBG8LXGIiyYbN2NLziLUqtCLXupBb71obyK20JdxUx/DNdW4625Kc0jI5Psm329mEzg7h8iHTUYDQcMFoq6YCmQ+i2mE5DANOIJVbqQJQtgA0QRhf0T1UuccExQ0/hYxHxK3bIMLmK3YxWMQhiS/TYNVajU9ikdkuyeH73rtc9yb9K9zj162nCFl0eKSU+fk8chKlcjuQHb6cnQnB6Ps4VZ2nvIGOyoa4cpdMguPrPvImgzTbRrRoOBbJnu8BcIsTp6vpqmcrSr2CLQ0P/lebrJ29292Lj59ER5Z/UXLHt/k+KIczbTVKSKItKDZTxSH0mHiYtG9Nob+5/kxjNPikbViRZevH8P7co5/vgMWHfGWtRzqn6jCjPUYbRyr0VLMx2TYtziPQVRP1UOd1C90+n+i"}),s[10]||(s[10]=n(`<p>系统服务的启动主要在 SystemServer 的 <code>main()</code> 方法中，按照以下顺序：</p><ol><li><strong>准备阶段</strong>：创建系统上下文、加载本地库等</li><li><strong>启动引导服务</strong>：<code>startBootstrapServices()</code></li><li><strong>启动核心服务</strong>：<code>startCoreServices()</code></li><li><strong>启动其他服务</strong>：<code>startOtherServices()</code></li><li><strong>进入消息循环</strong>：<code>Looper.loop()</code></li></ol><h2 id="系统服务的注册与获取" tabindex="-1"><a class="header-anchor" href="#系统服务的注册与获取"><span>系统服务的注册与获取</span></a></h2><h3 id="服务注册" tabindex="-1"><a class="header-anchor" href="#服务注册"><span>服务注册</span></a></h3><p>系统服务在启动时，会将自己注册到 ServiceManager 中：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 在SystemServer.java中</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ServiceManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">addService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ACTIVITY_SERVICE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ActivityManagerService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="服务获取" tabindex="-1"><a class="header-anchor" href="#服务获取"><span>服务获取</span></a></h3><p>应用获取系统服务的方式：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 通过Context获取</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ActivityManager</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> am</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ActivityManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getSystemService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ACTIVITY_SERVICE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 或者直接通过ServiceManager获取</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">IBinder</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> binder</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ServiceManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ACTIVITY_SERVICE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">IActivityManager</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> am</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> IActivityManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Stub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">asInterface</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">binder</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="系统服务工作原理" tabindex="-1"><a class="header-anchor" href="#系统服务工作原理"><span>系统服务工作原理</span></a></h2><p>Android 系统服务工作原理基于 Binder IPC 机制，其流程如下：</p>`,11)),a(i,{id:"mermaid-303",code:"eJxLL0osyFDwCeJSAALH6KfrFj3r2P589XrHAM9YBV1du5oXG5qfT1lRo+CEkAsuKU3SCyjKr6iMBWtzAit0ysxLSS16smfBi32TaxSco5/N6X3atRCqHKLQGcnEp+vmPe/bUKPgAlUI4UPUuUDU7Z/ydPa857snP5s3B2ggkgmoVjkhOQKip0bBESwGJopLKnNSFRwV0jJzcqyULQ2cHd0sdYpLivKzU62UDU3NTJ0NoFzd8syUkgwro4IKJI1OOs5QrW5urgYWRnCtbm4WbgZ4tbpANTqaupg5msM1GrmauxjDzEHSCAA9jZZs"}),s[11]||(s[11]=n(`<ol><li><strong>客户端 API 调用</strong>：应用程序调用系统提供的客户端 API</li><li><strong>客户端 Proxy 处理</strong>：将调用参数打包，通过 Binder 发送到服务端</li><li><strong>服务端 Stub 接收</strong>：接收客户端请求，解析参数</li><li><strong>服务实现处理</strong>：执行实际的服务实现逻辑</li><li><strong>返回结果</strong>：将处理结果通过 Binder 返回给客户端</li></ol><h2 id="自定义系统服务" tabindex="-1"><a class="header-anchor" href="#自定义系统服务"><span>自定义系统服务</span></a></h2><p>除了 Android 系统自带的服务外，开发者也可以创建自定义系统服务：</p><h3 id="_1-定义服务接口-aidl" tabindex="-1"><a class="header-anchor" href="#_1-定义服务接口-aidl"><span>1. 定义服务接口（AIDL）</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// IMyService.aidl</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">package</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">example</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">interface</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> IMyService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> setData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    String </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-实现服务类" tabindex="-1"><a class="header-anchor" href="#_2-实现服务类"><span>2. 实现服务类</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> MyService</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> extends</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> IMyService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Stub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> TAG</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">MyService</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> mData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> MyService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Context </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 初始化</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Override</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> setData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        mData </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Override</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> String </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> mData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-注册到-systemserver" tabindex="-1"><a class="header-anchor" href="#_3-注册到-systemserver"><span>3. 注册到 SystemServer</span></a></h3><p>修改 <code>SystemServer.java</code> 的 <code>startOtherServices()</code> 方法：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    Slog</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">TAG</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">My Service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    myService </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> MyService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    ServiceManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">addService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">my_service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> myService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Throwable </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    reportWtf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">starting My Service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-客户端调用" tabindex="-1"><a class="header-anchor" href="#_4-客户端调用"><span>4. 客户端调用</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 获取服务</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">IBinder</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> binder</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ServiceManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">my_service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">IMyService</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> IMyService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Stub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">asInterface</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">binder</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 调用方法</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Hello</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="系统服务的生命周期" tabindex="-1"><a class="header-anchor" href="#系统服务的生命周期"><span>系统服务的生命周期</span></a></h2><p>系统服务通常在系统启动时创建，在系统关闭时销毁，具有以下生命周期阶段：</p>`,14)),a(i,{id:"mermaid-362",code:"eJxLL0osyFAIceFSAALH6GfzWl42LHjavvfZ1A2xCrq6djVPO+Y+Xd79tGdajYJTdH5ecEliUUksWLUTWP7F/gkvFvbUKDhHP1u7+OmOHU+3L32yd87zrm3PGhoh6pwh5rRufjl9bY2CC9AQl9TikqL8Sog0mCguqcxJBZqYlpmTY6Xs5uZqYGGkA1KUnQriWrgZGEC5uuWZKSUZVkYFFUganaEaHU1dzBzN4RqNXM1djGHmIGkEALCcXOs="}),s[12]||(s[12]=n(`<ol><li><strong>创建阶段</strong>：服务对象被创建，进行初始化</li><li><strong>启动阶段</strong>：调用 <code>onStart()</code> 方法，注册到 ServiceManager</li><li><strong>工作阶段</strong>：响应客户端请求，执行服务逻辑</li><li><strong>销毁阶段</strong>：系统关闭时，调用 <code>onDestroy()</code> 方法释放资源</li></ol><h2 id="系统服务的调试" tabindex="-1"><a class="header-anchor" href="#系统服务的调试"><span>系统服务的调试</span></a></h2><h3 id="_1-dumpsys-命令" tabindex="-1"><a class="header-anchor" href="#_1-dumpsys-命令"><span>1. dumpsys 命令</span></a></h3><p>通过 <code>adb shell dumpsys</code> 命令可以查看系统服务的状态信息：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 显示所有服务</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shell</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dumpsys</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 显示特定服务</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shell</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dumpsys</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> activity</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shell</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dumpsys</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> window</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shell</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dumpsys</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> package</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-查看服务日志" tabindex="-1"><a class="header-anchor" href="#_2-查看服务日志"><span>2. 查看服务日志</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 过滤特定服务的日志</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> logcat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ActivityManager</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> logcat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> WindowManager</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-监控-binder-通信" tabindex="-1"><a class="header-anchor" href="#_3-监控-binder-通信"><span>3. 监控 Binder 通信</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看 Binder 事务</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shell</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /sys/kernel/debug/binder/transactions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看 Binder 状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">adb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shell</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /sys/kernel/debug/binder/stats</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="常见问题与解决方案" tabindex="-1"><a class="header-anchor" href="#常见问题与解决方案"><span>常见问题与解决方案</span></a></h2><h3 id="_1-服务无响应-anr" tabindex="-1"><a class="header-anchor" href="#_1-服务无响应-anr"><span>1. 服务无响应（ANR）</span></a></h3><p>系统服务处理请求时间过长可能导致 ANR：</p><ul><li><strong>原因</strong>：服务方法中执行耗时操作</li><li><strong>解决方案</strong>：将耗时操作放到工作线程中处理</li></ul><h3 id="_2-权限问题" tabindex="-1"><a class="header-anchor" href="#_2-权限问题"><span>2. 权限问题</span></a></h3><p>某些系统服务需要特殊权限才能访问：</p><ul><li><strong>原因</strong>：服务有权限保护</li><li><strong>解决方案</strong>：在 Manifest 中声明所需权限，或使用签名级别权限</li></ul><h3 id="_3-进程间通信失败" tabindex="-1"><a class="header-anchor" href="#_3-进程间通信失败"><span>3. 进程间通信失败</span></a></h3><p>Binder 通信可能因各种原因失败：</p><ul><li><strong>原因</strong>：服务进程已死亡，Binder 缓冲区已满等</li><li><strong>解决方案</strong>：添加错误处理，使用死亡通知机制</li></ul><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>系统服务是 Android Framework 层的核心组成部分，为整个系统提供基础功能支持。深入理解系统服务的工作原理和实现细节，对于进行系统级开发、解决系统问题和优化应用性能都有很大帮助。通过本文的介绍，希望读者能对 Android 系统服务有一个全面的了解。</p><hr><h2 id="参考资源" tabindex="-1"><a class="header-anchor" href="#参考资源"><span>参考资源</span></a></h2><ul><li><a href="https://source.android.com/" target="_blank" rel="noopener noreferrer">Android 开源项目</a></li><li><a href="https://android.googlesource.com/" target="_blank" rel="noopener noreferrer">Android 源码</a></li><li>《深入理解 Android 内核设计思想》</li><li>《Android 系统源代码情景分析》</li></ul>`,24))])}const g=l(r,[["render",k]]),o=JSON.parse('{"path":"/android/zts8xro7/","title":"系统服务概览","lang":"zh-CN","frontmatter":{"title":"系统服务概览","createTime":"2025/04/29 14:32:19","permalink":"/android/zts8xro7/"},"headers":[],"readingTime":{"minutes":7.57,"words":2272},"git":{"updatedTime":1745914733000,"contributors":[{"name":"Henry Thomas","username":"Henry Thomas","email":"henrythomas9587@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/Henry Thomas?v=4","url":"https://github.com/Henry Thomas"}]},"filePathRelative":"notes/android/framework/02/系统服务概览.md","bulletin":false}');export{g as comp,o as data};
