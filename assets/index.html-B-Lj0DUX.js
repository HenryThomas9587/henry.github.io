import{_ as s,c as i,b as a,a as e,d as r,e as n,r as o,o as l}from"./app-BNwF3TyR.js";const p={};function h(u,t){const d=o("Mermaid");return l(),i("div",null,[t[0]||(t[0]=a("blockquote",null,[a("p",null,[n("本章基于 "),a("a",{href:"https://ddia.vonng.com/ch8/",target:"_blank",rel:"noopener noreferrer"},"DDIA 中文翻译"),n(" 整理")])],-1)),t[1]||(t[1]=a("h2",{id:"章节概览",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#章节概览"},[a("span",null,"章节概览")])],-1)),e(d,{id:"mermaid-8",code:"eJydk11P01AYx+/5FE24lbi+ja0XJu1pm5BoYiQxJidcmIhCJJEAiXo3QAboRmcC48UJQiYzEgpMhLGx+GV6ztorv4JnPaddi4RQuGDbef6/5/yfl/Nq6vnkGPfwSR9H/lToND+hj7sj3MDAA06DKhjSOXSyjXO1ESrwAwB6W6ud/VanWUNLB9GIDtHFGbI+e+u2t7cRjRgQ2dudlWNkHTmNurtbQIVyNG5CtJRHjXl0aTEPfX5Uo1Z4iFZ20GGJOFE4tPADV5bxUrn7Zf0bTcOEAnQaOXfx1Bfi1q579qvT3Mdfd2IqkVVA01HL/kFMJUFcmHUuFmiutWNctJ1G0WnsoeoJswdoQ3joHrVw5Se2Sk6zSsSVHLokmohE6ErQeT2QeBt1fLjnfrDI8X3ygfKbMb0I0Z+DzkKN+lK4R08B+HtZYBhJNWvhciWGSDDaXeaiyZzqdEDE6f9Xshi16OflSKEkmbdYRNUiOY3pRNLjbg/wl1NcPo6FiIX8ZtQaO5fJYrT8PP6pQXeCJ4m6bvFyjfxXuI6dQ8U1p51HpW1UKnmLltNeoXkY0R1v1ds4w/Zvb3UW2Vukyrm6W5sjrSFjcufb6NyOESIcHh5SOOeiFFN9bzMrJl2/rhWWmE6IEx4DmogpBPhM5WK7OT3zfmKU7O/L8YkJpT+bAqqZvTc9M/Xm9ajSz8tpGaTYz4G34y9mxhRx8l0E1BhomkYqI4SgaWbM1BVQiIGAgaqsp9XBEBSMQV0M8lwL6uGNqpblQ1DPSCIv3wQaDARGVtQzIZhWeS2r3gSayWqMdocPUTMLpB4qD5p8UDRD+XhfhTuT4p1JKRkZnWZQKMgYaRBZIE02hCs9il8KgkKTk0Ghycmg0FuS0e3rTRQADYSoZorpVPDz2kv13kSTkr2JJiV7E01KysnI6DsLWmTwmmH0nrak8lLmxkuNoEXJyaBFtySjr/vOb9RM+Eb/AcxcJr0="}),t[2]||(t[2]=r('<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>事务是应用程序将多个读写操作组合成一个逻辑单元的方式。事务提供了简化的编程模型，让开发者可以忽略某些潜在的错误场景和并发问题。</p><blockquote><p>&quot;事务可以大大减少你需要考虑的潜在错误情况的数量。&quot;</p></blockquote><h2 id="acid-属性" tabindex="-1"><a class="header-anchor" href="#acid-属性"><span>ACID 属性</span></a></h2><h3 id="原子性-atomicity" tabindex="-1"><a class="header-anchor" href="#原子性-atomicity"><span>原子性（Atomicity）</span></a></h3><p><strong>定义</strong>：事务中的所有操作要么全部成功，要么全部失败回滚。</p>',6)),e(d,{id:"mermaid-29",code:"eJydz89KwzAABvC7TxHY1Ur/2K7tQUmbZi/grewgON2w4NgKKlbQk9oxVvDi36m16lGEgTDd2zRhvoVbGssQKbjcku/7wZet1nqzDtbQApgc6KbDDgkfyOcReelUgSCsAMul5910dCOZgJ49kpPeePBMT99hOrr8im+rzFmsafOmbAIS90l4nzWt2abNmuiAXrySaJJGJLxbPWQRmkZB9hQAx6W9KB0mGcsykryNB08BwC657tOPqyzDQFiahuyJbw1AxaXHMUm6v9Yy0fb3vRqAYLPheWbJEG2IjcW239rZrpklSdVUW+RXYbex4ddNubk3Ay0OMXZEXc4hxjoWC6E9L0Qc2o6hID2HGpQsAxZBh0OoIg2Wcyg7ZaT8DPgT4nwqtAwph0hfViS1CFb+98dvZwHtzw=="}),t[3]||(t[3]=r('<p><strong>说明</strong>：如果操作2失败，操作1也会回滚</p><p><strong>关键点</strong>：</p><ul><li>描述故障时的行为，而非并发</li><li>提供全有或全无的保证</li><li>失败后可以安全重试</li></ul><h3 id="一致性-consistency" tabindex="-1"><a class="header-anchor" href="#一致性-consistency"><span>一致性（Consistency）</span></a></h3><p><strong>定义</strong>：事务将数据库从一个有效状态转换到另一个有效状态，满足所有定义的约束。</p><p><strong>注意</strong>：一致性主要依赖于应用程序如何正确定义事务，而非数据库本身。</p><h3 id="隔离性-isolation" tabindex="-1"><a class="header-anchor" href="#隔离性-isolation"><span>隔离性（Isolation）</span></a></h3><p><strong>定义</strong>：并发执行的事务彼此隔离，不能相互干扰。</p><p><strong>理想情况</strong>：可串行化（Serializability）—— 事务的执行结果与串行执行相同。</p><p><strong>现实情况</strong>：由于性能原因，常使用较弱的隔离级别。</p><h3 id="持久性-durability" tabindex="-1"><a class="header-anchor" href="#持久性-durability"><span>持久性（Durability）</span></a></h3><p><strong>定义</strong>：一旦事务成功提交，数据不会丢失。</p><table><thead><tr><th>环境</th><th>实现方式</th></tr></thead><tbody><tr><td>单节点</td><td>写入非易失性存储（磁盘、SSD）</td></tr><tr><td>分布式</td><td>数据成功复制到多个节点</td></tr></tbody></table><h2 id="隔离级别" tabindex="-1"><a class="header-anchor" href="#隔离级别"><span>隔离级别</span></a></h2><h3 id="读未提交-read-uncommitted" tabindex="-1"><a class="header-anchor" href="#读未提交-read-uncommitted"><span>读未提交（Read Uncommitted）</span></a></h3><p>最弱的隔离级别，允许脏读。实际中很少使用。</p><h3 id="读已提交-read-committed" tabindex="-1"><a class="header-anchor" href="#读已提交-read-committed"><span>读已提交（Read Committed）</span></a></h3><p><strong>保证</strong>：</p><ul><li><strong>无脏读</strong>：只能看到已提交的数据</li><li><strong>无脏写</strong>：不会覆盖未提交的数据</li></ul><p><strong>实现</strong>：</p><ul><li>写入时持有行级锁直到提交</li><li>读取时返回已提交的旧值</li></ul><p><strong>仍存在的问题</strong>：读偏斜（不可重复读）</p><h3 id="快照隔离-snapshot-isolation" tabindex="-1"><a class="header-anchor" href="#快照隔离-snapshot-isolation"><span>快照隔离（Snapshot Isolation）</span></a></h3><p><strong>核心思想</strong>：每个事务从数据库的一致快照读取。</p>',24)),e(d,{id:"mermaid-161",code:"eJxLL0osyFDwCeJSAALH6Ce7up92LXy6p+Hp8u5n07c97Zj9dPeup/tXP29dHqugq2un4BT9Yv3up/3TrBSAKp7v7niyuw8iDRGOBZvjBFbqHP20bebT1qVApWD62bQNzzs7ns1ZA1HkDFbkEv2sf8KTXUusFJ4tbng2f+nTtk3PVzXGcoGVFJdU5qQqOCqkZebkWClbGjg7ulnqFJcU5WenWikbmpqZOhtAubrlmSklGVZGBRVIGp2gGt3cXA0sjOAa3dws3AzwanSGanQ0dTFzNIdrNHI1dzGGmYNVowtUo7OrpbGLBVyjmaOhk6UjpkYA9X2Uzw=="}),t[4]||(t[4]=r('<p><strong>MVCC（多版本并发控制）</strong>：</p><ul><li>每行数据保存多个版本</li><li>每个版本标记创建和删除的事务ID</li><li>读取时根据事务ID选择可见版本</li></ul><p><strong>优点</strong>：</p><ul><li>读者不阻塞写者</li><li>写者不阻塞读者</li><li>防止读偏斜</li></ul><p><strong>仍存在的问题</strong>：写偏斜</p><h3 id="可串行化-serializable" tabindex="-1"><a class="header-anchor" href="#可串行化-serializable"><span>可串行化（Serializable）</span></a></h3><p>最强的隔离级别，防止所有并发问题。</p><h2 id="并发问题" tabindex="-1"><a class="header-anchor" href="#并发问题"><span>并发问题</span></a></h2><h3 id="脏读-dirty-read" tabindex="-1"><a class="header-anchor" href="#脏读-dirty-read"><span>脏读（Dirty Read）</span></a></h3><p>读取到其他事务未提交的数据。</p>',10)),e(d,{id:"mermaid-220",code:"eJwrTi0sTc1LTnXJTEwvSszlUgCCgsSikszkzILEvBIFR4XEYoUnu7qfdi10xJB0cQLJPpu64Vnvuqe7JmPIg6Uhmp24wLKOunZ2Lk5WCk/bZj5tXapQYWuooPFszqpn/ROe7FqiCVbiBFXyYv3up/3TIEpetPQDuRB5v/ySVIX8stQiBaiijg1wE57PaoG4BtWy2fOe7Z6FSzNcz7PpC55N7YC4Mym/QqEoPSlRw8jUVEfB0NwQSJgAWQZ6xpo4gwMikpqXgsUIIyMToBHGBihGOGGGGNwIAPS7msM="}),t[5]||(t[5]=r('<p><strong>解决</strong>：读已提交隔离级别</p><h3 id="脏写-dirty-write" tabindex="-1"><a class="header-anchor" href="#脏写-dirty-write"><span>脏写（Dirty Write）</span></a></h3><p>覆盖其他事务未提交的写入。</p><p><strong>解决</strong>：行级锁</p><h3 id="读偏斜-read-skew" tabindex="-1"><a class="header-anchor" href="#读偏斜-read-skew"><span>读偏斜（Read Skew）</span></a></h3><p>在同一事务中，读取到不一致的数据状态。</p>',6)),e(d,{id:"mermaid-239",code:"eJwrTi0sTc1LTnXJTEwvSszlUgCCgsSikszkzILEvBIFR4XEYoUnu7qfdi10xJB0cQLJPpu64Vnvuqe7JmPIg6Uhmp24wLKOunZ2Lk5WCi/W737aP+3FlmXPOrYbPtk78+WiubamBgZgNU4wNXvXABUYGhgoaEAVPmqbBGEZaaKofNY/4cmuJTgtMIJaYAa1wC+/JFUhvyy1SMHRSuH5nO6nHRueNewGqTAE2/ZkR++THQ0v2rcoQqxBUf903byXM1sh6p/umvJi/dJnM9YDtRlAPJiUX6FQlJ6UqGFoYqKjYGRgBCRMLHUUDPSMNXGGI0QkNS8F1QgjU1OgbiOgOYbGBihGOGEGNdwIAL/ZtC4="}),t[6]||(t[6]=a("p",null,[a("strong",null,"解决"),n("：快照隔离")],-1)),t[7]||(t[7]=a("h3",{id:"丢失更新-lost-update",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#丢失更新-lost-update"},[a("span",null,"丢失更新（Lost Update）")])],-1)),t[8]||(t[8]=a("p",null,"两个事务并发执行读-修改-写循环，一个更新被覆盖。",-1)),e(d,{id:"mermaid-249",code:"eJwrTi0sTc1LTnXJTEwvSszlUgCCgsSikszkzILEvBIFR4XEYoUnu7qfdi10xJB0cQLJPpu64Vnvuqe7JmPIg6Uhmp24wLKOunZ2Lk5WCi/W737aP00hOb80ryS1yNbQACzrhFcWpvdp28ynrUsRsoYoerHL+uWXpCrkl6UWAd1sBfPP81ktz2ZveTZtw5Mdi54u2aiIReWzOQ3Pd3c8bdjzdNeUF+uXPpux3tAI4pOk/AqFovSkRA1DExMdBSMDIyBhYqmjYKBnrIkzwCAiqXkpqEYYmZoCdRsBzTE0NkAxwgkzTOFGAADAR5+x"}),t[9]||(t[9]=r('<p><strong>解决方案</strong>：</p><table><thead><tr><th>方案</th><th>描述</th></tr></thead><tbody><tr><td>原子操作</td><td><code>UPDATE ... SET counter = counter + 1</code></td></tr><tr><td>显式锁定</td><td><code>SELECT ... FOR UPDATE</code></td></tr><tr><td>自动检测</td><td>数据库检测并回滚一个事务</td></tr><tr><td>CAS 操作</td><td><code>UPDATE ... WHERE counter = old_value</code></td></tr></tbody></table><h3 id="写偏斜-write-skew" tabindex="-1"><a class="header-anchor" href="#写偏斜-write-skew"><span>写偏斜（Write Skew）</span></a></h3><p>两个事务读取相同数据，根据读取结果做出决策并写入，但决策前提在写入时已不成立。</p>',4)),e(d,{id:"mermaid-305",code:"eJwrTi0sTc1LTnXJTEwvSszlUgCCgsSikszkzILEvBIFR4XEYoUnu7qfdi10VNB42rP7+ZT5hpoYylycQOqeTd3wrHfd012TMeTB0hBjnGDGGGlygdX55ZekKuSXpRYBTbFSeL5r2bO5860UXrRvfrph4rM5nU92NDyd0AvR8rRhz/P+tWBdjrp2diD1z+YvfbF+EUQCogjoClsjsBonItQgbHe0UnjatvnpullPdnQDFSpovNg/A2i/4ZNduyBaId5GaACaTIwGuEtnb3k2bcOL9lVPt298smPXkx29SN6BOxWfIrSQ2j352bw5QC3TF8BtBLlh7tP+XkgoKkJDOCm/QqEoPSlRw9DEREfByMAISJhY6igY6BlrwiIXM+bBIql5KahGGJmaAnUbAc0xNDZAMcIJM9bhRgAAcDwPJQ=="}),t[10]||(t[10]=a("p",null,[a("strong",null,"解决"),n("：可串行化隔离")],-1)),t[11]||(t[11]=a("h3",{id:"幻读-phantom-read",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#幻读-phantom-read"},[a("span",null,"幻读（Phantom Read）")])],-1)),t[12]||(t[12]=a("p",null,"一个事务的写入改变另一个事务搜索查询的结果。",-1)),e(d,{id:"mermaid-315",code:"eJwrTi0sTc1LTnXJTEwvSszlUgCCgsSikszkzILEvBIFR4XEYoUnu7qfdi10xJB0cQLJPpu64Vnvuqe7JmPIg6Uhmp24wLKOunZ2Lk5WCs/mL32xftGTPbNerFv3dN0SQyMrAwNdQ2Mg+Wz6gpeLWl6sWwRW7wRT3z/paetSbOqxKp7wZNcSVPuI0Y9QDNfvl1+SqpBflloE9KuVwvPdk5/Nm2Ol8LS/52V7L0SnIsRjSfkVCkXpSYkahiYmOgpGBkZAwsRSR8FAz1gTZ/hBRFLzUlCNMDI1Beo2AppjaGyAYoQTZhDDjQAAMFCsJg=="}),t[13]||(t[13]=r('<p><strong>解决</strong>：谓词锁或索引范围锁</p><h2 id="实现可串行化" tabindex="-1"><a class="header-anchor" href="#实现可串行化"><span>实现可串行化</span></a></h2><h3 id="方案一-串行执行" tabindex="-1"><a class="header-anchor" href="#方案一-串行执行"><span>方案一：串行执行</span></a></h3><p>单线程顺序执行所有事务。</p><p><strong>适用条件</strong>：</p><ul><li>事务简短</li><li>数据集可放入内存</li><li>写入吞吐量低</li></ul><p><strong>优化</strong>：</p><ul><li>存储过程减少网络往返</li><li>分区并行执行</li></ul><h3 id="方案二-两阶段锁定-2pl" tabindex="-1"><a class="header-anchor" href="#方案二-两阶段锁定-2pl"><span>方案二：两阶段锁定（2PL）</span></a></h3><p><strong>规则</strong>：</p><ul><li>读取前获取共享锁</li><li>写入前获取排他锁</li><li>持有锁直到事务结束</li></ul><p><strong>问题</strong>：</p><ul><li>性能差（读写互相阻塞）</li><li>死锁风险</li><li>延迟不可预测</li></ul><p><strong>谓词锁</strong>：锁定满足条件的所有行（包括未来的行）</p><p><strong>索引范围锁</strong>：锁定索引范围，是谓词锁的近似实现</p><h3 id="方案三-可串行化快照隔离-ssi" tabindex="-1"><a class="header-anchor" href="#方案三-可串行化快照隔离-ssi"><span>方案三：可串行化快照隔离（SSI）</span></a></h3><p><strong>核心思想</strong>：乐观并发控制 + 冲突检测</p>',17)),e(d,{id:"mermaid-418",code:"eJxLL0osyFDwCeJSAALHaEM9hSe7up92LXw6Z8XT/aufty5/sqPrWefyFwt7bJKK9O2e7Oh9OWP304XzYhV0de0UnKKN9BSe9U94smvJs+nbni1ueLa1+2nbpuerGmPBBjqBVTlXP5ux/umEZc/mdEIk7WvBss4g2Zpn0xdARGsUXKKhZnVMeNo1H2IEVBFMa42Ca/TT2fOe7Z71sr33xfqpsVxgVcUllTmpCo4KaZk5OVbKlgbOjm6WOsUlRfnZqVbKhqZmps4GUK5ueWZKSYaVUUEFkkYnqEY3N1cDCyO4Rjc3CzcDvBqdoRqdXS2NXSzgGs0cDZ0sHfFpdIFqdDR1MXM0h2s0cjV3MYY5AKtGV7hTHZ0sDeEaXSxMjA1NMTUCAO3XuRw="}),t[14]||(t[14]=r('<p><strong>检测的冲突类型</strong>：</p><ul><li>读取被其他事务修改的数据</li><li>写入被其他事务读取的数据</li></ul><p><strong>优点</strong>：</p><ul><li>读不阻塞写</li><li>写不阻塞读</li><li>性能好于 2PL</li></ul><p><strong>缺点</strong>：</p><ul><li>高冲突时回滚率高</li><li>需要重试逻辑</li></ul><h2 id="隔离级别对比" tabindex="-1"><a class="header-anchor" href="#隔离级别对比"><span>隔离级别对比</span></a></h2><table><thead><tr><th>隔离级别</th><th>脏读</th><th>脏写</th><th>读偏斜</th><th>丢失更新</th><th>写偏斜</th><th>幻读</th></tr></thead><tbody><tr><td>读未提交</td><td>可能</td><td>防止</td><td>可能</td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td>读已提交</td><td>防止</td><td>防止</td><td>可能</td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td>快照隔离</td><td>防止</td><td>防止</td><td>防止</td><td>部分防止</td><td>可能</td><td>可能</td></tr><tr><td>可串行化</td><td>防止</td><td>防止</td><td>防止</td><td>防止</td><td>防止</td><td>防止</td></tr></tbody></table><h2 id="分布式事务" tabindex="-1"><a class="header-anchor" href="#分布式事务"><span>分布式事务</span></a></h2><h3 id="两阶段提交-2pc" tabindex="-1"><a class="header-anchor" href="#两阶段提交-2pc"><span>两阶段提交（2PC）</span></a></h3><p><strong>角色</strong>：</p><ul><li>协调者（Coordinator）</li><li>参与者（Participants）</li></ul><p><strong>流程</strong>：</p>',13)),e(d,{id:"mermaid-617",code:"eJwrTi0sTc1LTnXJTEwvSszlUgCCgsSikszkzILEvBIFZ4XEYoWnvf0vNjS/aGjFkA4wBMv3Nz3Z0QeUN8RUYISiwAhTgTGKAmMusAq//JJUhfyy1CIFZ50AYyuFlzO2PVu31dBK4Wl729Ml7WA1zrp2dgFwoWf9E57sWmKPkDHCKQM0D1MmwFAXKOdspfBsxnqIgBG6gDGSAB5XAi2GGAxWk5hTovCss+HZnE64H5/Onvd87RQloDFKYCXInkHSiewTbMJAC5GEU3OKUxWe7N79ZEcDukVPJyzDtAgo92z3LAyLsAmDwgshnJqXAvF9Un6FQlF6UqKGoYmJjoKRgRGQMLHUUTDQM9bEk2Sc4aagGGJkagrUbwQ0ydDYAGYIzCNY0h2WlIYlbcHtAgA/YA2/"}),t[15]||(t[15]=r('<p><strong>问题</strong>：</p><ul><li>协调者单点故障</li><li>参与者可能&quot;存疑&quot;阻塞</li><li>性能开销大</li></ul><h3 id="xa-事务" tabindex="-1"><a class="header-anchor" href="#xa-事务"><span>XA 事务</span></a></h3><p>跨异构系统的分布式事务标准，问题较多，现代系统倾向于避免使用。</p><h2 id="核心要点" tabindex="-1"><a class="header-anchor" href="#核心要点"><span>核心要点</span></a></h2><ul><li>事务简化了并发和故障处理的编程模型</li><li>隔离级别是性能和正确性的权衡</li><li>可串行化是最强保证，但有性能代价</li><li>SSI 是现代数据库的首选可串行化实现</li><li>分布式事务复杂且有性能问题，应谨慎使用</li></ul>',6))])}const m=s(p,[["render",h]]),b=JSON.parse('{"path":"/ddia/fm1ruuoh/","title":"第8章 事务","lang":"zh-CN","frontmatter":{"title":"第8章 事务","createTime":"2025/12/26 16:12:00","permalink":"/ddia/fm1ruuoh/"},"headers":[],"readingTime":{"minutes":9.1,"words":2730},"git":{"updatedTime":1766740079000,"contributors":[{"name":"aidenreed937","username":"aidenreed937","email":"aidenreed937@gmail.com","commits":4,"avatar":"https://avatars.githubusercontent.com/aidenreed937?v=4","url":"https://github.com/aidenreed937"},{"name":"Claude Opus 4.5","username":"Claude Opus 4.5","email":"noreply@anthropic.com","commits":3,"avatar":"https://avatars.githubusercontent.com/Claude Opus 4.5?v=4","url":"https://github.com/Claude Opus 4.5"},{"name":"Claude Sonnet 4.5","username":"Claude Sonnet 4.5","email":"noreply@anthropic.com","commits":1,"avatar":"https://avatars.githubusercontent.com/Claude Sonnet 4.5?v=4","url":"https://github.com/Claude Sonnet 4.5"}]},"filePathRelative":"notes/ddia/part2-distributed/chapter-08.md","bulletin":false}');export{m as comp,b as data};
