import{_ as i,c as a,d as n,o as l}from"./app-BNwF3TyR.js";const e={};function h(t,s){return l(),a("div",null,[...s[0]||(s[0]=[n(`<h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h2><p>Android系统的安全架构基于多层防御策略，包括应用沙盒、权限系统、加密存储和安全通信等。本文将深入探讨Android Framework层中的安全机制实现，包括权限管理、应用签名验证、SELinux策略等核心安全特性。</p><h2 id="安全架构概述" tabindex="-1"><a class="header-anchor" href="#安全架构概述"><span>安全架构概述</span></a></h2><p>Android的安全架构构建在以下几个关键层面：</p><ol><li><strong>Linux内核安全</strong>：进程隔离、文件访问控制、内存保护</li><li><strong>应用沙盒</strong>：每个应用运行在独立的沙盒环境中</li><li><strong>权限系统</strong>：细粒度的功能访问控制</li><li><strong>应用签名</strong>：确保应用完整性和来源可信</li><li><strong>安全启动</strong>：验证系统完整性的启动链</li><li><strong>SELinux强制访问控制</strong>：限制进程的系统资源访问</li></ol><h2 id="权限系统实现" tabindex="-1"><a class="header-anchor" href="#权限系统实现"><span>权限系统实现</span></a></h2><h3 id="权限定义与分类" tabindex="-1"><a class="header-anchor" href="#权限定义与分类"><span>权限定义与分类</span></a></h3><p>Android权限系统在Framework层中的主要实现位于<code>PermissionManagerService</code>：</p><ul><li><strong>普通权限</strong>：安装时自动授予</li><li><strong>危险权限</strong>：需要用户明确授权</li><li><strong>特殊权限</strong>：需要通过特定方式授予</li><li><strong>系统权限</strong>：仅供系统应用使用</li></ul><p>权限定义示例(AndroidManifest.xml)：</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">permission</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    android</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">android.permission.CAMERA</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    android</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">description</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">@string/permlab_camera</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    android</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">label</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">@string/permlab_camera</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    android</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">protectionLevel</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">dangerous</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> /&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="权限检查流程" tabindex="-1"><a class="header-anchor" href="#权限检查流程"><span>权限检查流程</span></a></h3><ol><li>应用请求访问受保护功能</li><li>Framework层调用<code>checkPermission()</code>方法</li><li><code>PermissionManagerService</code>验证应用是否持有所需权限</li><li>如未授权，抛出<code>SecurityException</code></li></ol><p>核心实现示例：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 权限检查的简化实现</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> checkPermission</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String permission</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> pid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> uid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">permission </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> PackageManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">PERMISSION_DENIED</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 检查是否是系统进程</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uid </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Process</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ROOT_UID</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> uid </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Process</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SYSTEM_UID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> PackageManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">PERMISSION_GRANTED</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 查询权限状态</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> mPackageManagerInternal</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">checkUidPermission</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">permission</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> uid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="运行时权限管理" tabindex="-1"><a class="header-anchor" href="#运行时权限管理"><span>运行时权限管理</span></a></h3><p>Android 6.0引入的运行时权限由<code>PermissionController</code>管理，主要组件包括：</p><ul><li><strong>PermissionManagerService</strong>：核心权限管理服务</li><li><strong>PermissionDialogReqQueue</strong>：权限请求队列</li><li><strong>PackageManager</strong>：应用包管理</li><li><strong>PermissionPolicyService</strong>：权限策略实施</li></ul><h2 id="应用签名与验证" tabindex="-1"><a class="header-anchor" href="#应用签名与验证"><span>应用签名与验证</span></a></h2><h3 id="签名机制" tabindex="-1"><a class="header-anchor" href="#签名机制"><span>签名机制</span></a></h3><p>Android要求所有应用必须签名，签名验证在<code>PackageManagerService</code>中实现：</p><ol><li>安装应用时验证APK签名</li><li>验证更新时的签名一致性</li><li>基于签名实现特权授予</li></ol><h3 id="签名验证流程" tabindex="-1"><a class="header-anchor" href="#签名验证流程"><span>签名验证流程</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 签名验证简化实现</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> verifySignatures</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">PackageParser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Package</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> pkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> throws PackageManagerException </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mSignatures</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        throw</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PackageManagerException</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                INSTALL_PARSE_FAILED_NO_CERTIFICATES</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Package has no certificates</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 对已安装应用的更新，验证签名一致性</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mPackages</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">containsKey</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">packageName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        PackageParser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Package</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> existingPkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> mPackages</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">packageName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">compareSignatures</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">existingPkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mSignatures</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pkg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mSignatures</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            throw</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PackageManagerException</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                    INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Update signature mismatch</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="selinux实现" tabindex="-1"><a class="header-anchor" href="#selinux实现"><span>SELinux实现</span></a></h2><h3 id="selinux在android中的应用" tabindex="-1"><a class="header-anchor" href="#selinux在android中的应用"><span>SELinux在Android中的应用</span></a></h3><p>Android使用SELinux（Security-Enhanced Linux）实现强制访问控制：</p><ol><li><strong>域隔离</strong>：应用和系统服务运行在不同SELinux域中</li><li><strong>策略定义</strong>：定义了各域可访问的资源</li><li><strong>强制执行</strong>：无视传统的Linux DAC权限，强制执行访问规则</li></ol><h3 id="selinux策略示例" tabindex="-1"><a class="header-anchor" href="#selinux策略示例"><span>SELinux策略示例</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span># app.te - 普通应用域策略示例</span></span>
<span class="line"><span>type untrusted_app, domain;</span></span>
<span class="line"><span># 允许应用访问自己的数据目录</span></span>
<span class="line"><span>allow untrusted_app app_data_file:dir create_dir_perms;</span></span>
<span class="line"><span>allow untrusted_app app_data_file:file create_file_perms;</span></span>
<span class="line"><span># 禁止应用访问系统数据</span></span>
<span class="line"><span>neverallow untrusted_app system_data_file:dir *;</span></span>
<span class="line"><span>neverallow untrusted_app system_data_file:file *;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="selinux集成" tabindex="-1"><a class="header-anchor" href="#selinux集成"><span>SELinux集成</span></a></h3><p>Framework通过<code>SELinuxPolicyInstaller</code>和<code>SELinuxMMAC</code>在启动时加载SELinux策略。<code>android.os.SELinux</code>类提供了Java API用于SELinux操作：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 检查SELinux是否启用</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> isEnabled</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> SELinux</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">isSELinuxEnabled</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 获取当前上下文</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> context</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> SELinux</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getContext</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 检查访问权限</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> hasAccess</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> SELinux</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">checkSELinuxAccess</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">u:r:system_app:s0</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                                            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">u:r:untrusted_app:s0</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                                            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">file</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">read</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安全存储" tabindex="-1"><a class="header-anchor" href="#安全存储"><span>安全存储</span></a></h2><h3 id="keystore系统" tabindex="-1"><a class="header-anchor" href="#keystore系统"><span>Keystore系统</span></a></h3><p>Android的<code>KeyStore</code>系统提供安全密钥存储：</p><ol><li><strong>硬件支持</strong>：在支持TEE或StrongBox的设备上，密钥材料保存在硬件中</li><li><strong>密钥隔离</strong>：每个应用只能访问自己创建的密钥</li><li><strong>用途限制</strong>：可以限制密钥的使用场景（仅签名、仅加密等）</li></ol><p>Framework实现由<code>KeyStoreService</code>和<code>Keymaster HAL</code>共同完成。</p><h3 id="文件加密" tabindex="-1"><a class="header-anchor" href="#文件加密"><span>文件加密</span></a></h3><p>Android提供两级文件加密：</p><ol><li><strong>全盘加密(FDE)</strong>：整个用户数据分区加密</li><li><strong>基于文件的加密(FBE)</strong>：单独加密每个文件，支持多用户隔离</li></ol><p>Framework中，由<code>StorageManagerService</code>和<code>VoldNativeService</code>实现加密相关功能。</p><h2 id="生物认证框架" tabindex="-1"><a class="header-anchor" href="#生物认证框架"><span>生物认证框架</span></a></h2><p>Android生物认证框架(<code>BiometricManager</code>)允许应用使用指纹、面部识别等进行身份验证：</p><ol><li><strong>统一API</strong>：应用使用统一接口而不关心具体实现</li><li><strong>安全存储</strong>：生物特征数据安全存储在TEE中</li><li><strong>HAL隔离</strong>：生物识别硬件通过HAL接口访问</li></ol><h2 id="系统完整性保护" tabindex="-1"><a class="header-anchor" href="#系统完整性保护"><span>系统完整性保护</span></a></h2><h3 id="验证启动" tabindex="-1"><a class="header-anchor" href="#验证启动"><span>验证启动</span></a></h3><p>Android实现了验证启动链：</p><ol><li><strong>硬件信任根</strong>：从硬件信任根开始验证</li><li><strong>引导加载程序</strong>：验证boot.img</li><li><strong>系统分区</strong>：验证system.img</li><li><strong>Verified Boot</strong>：确保设备以已知良好状态启动</li></ol><h3 id="dm-verity" tabindex="-1"><a class="header-anchor" href="#dm-verity"><span>dm-verity</span></a></h3><p>dm-verity提供运行时系统分区完整性保护：</p><ol><li>系统分区被构建为包含哈希树的只读映像</li><li>每次读取时验证块的完整性</li><li>如果检测到篡改，设备可能拒绝启动或进入只读模式</li></ol><h2 id="漏洞防护机制" tabindex="-1"><a class="header-anchor" href="#漏洞防护机制"><span>漏洞防护机制</span></a></h2><h3 id="aslr-地址空间布局随机化" tabindex="-1"><a class="header-anchor" href="#aslr-地址空间布局随机化"><span>ASLR(地址空间布局随机化)</span></a></h3><p>Android实现了完整的ASLR，随机化进程的内存布局：</p><ul><li>栈、堆、共享库、可执行文件的基址都被随机化</li><li>减少内存攻击的成功可能性</li></ul><h3 id="非执行内存-nx" tabindex="-1"><a class="header-anchor" href="#非执行内存-nx"><span>非执行内存(NX)</span></a></h3><p>Android强制执行NX位，防止数据页面被执行：</p><ul><li>标记堆、栈等为不可执行</li><li>防止代码注入攻击</li></ul><h3 id="控制流完整性-cfi" tabindex="-1"><a class="header-anchor" href="#控制流完整性-cfi"><span>控制流完整性(CFI)</span></a></h3><p>Android实现了CFI以防止控制流劫持：</p><ul><li>验证间接函数调用的合法性</li><li>防止返回导向编程(ROP)攻击</li></ul><h2 id="安全更新机制" tabindex="-1"><a class="header-anchor" href="#安全更新机制"><span>安全更新机制</span></a></h2><h3 id="安全补丁级别" tabindex="-1"><a class="header-anchor" href="#安全补丁级别"><span>安全补丁级别</span></a></h3><p>Android设备通过安全补丁级别(SPL)标识设备的安全状态：</p><ul><li>格式为&quot;YYYY-MM-DD&quot;</li><li>表示设备包含该日期之前的所有安全修复</li><li>通过<code>ro.build.version.security_patch</code>系统属性暴露</li></ul><h3 id="project-mainline" tabindex="-1"><a class="header-anchor" href="#project-mainline"><span>Project Mainline</span></a></h3><p>通过Google Play系统更新，Android可以直接更新关键系统组件：</p><ul><li>模块化的系统组件可通过Google Play更新</li><li>绕过OEM和运营商，直接修复安全漏洞</li><li>Framework中的<code>ModuleUpdateService</code>管理模块更新</li></ul><h2 id="实际应用与最佳实践" tabindex="-1"><a class="header-anchor" href="#实际应用与最佳实践"><span>实际应用与最佳实践</span></a></h2><h3 id="应用开发安全指南" tabindex="-1"><a class="header-anchor" href="#应用开发安全指南"><span>应用开发安全指南</span></a></h3><ol><li>最小权限原则：仅请求必需权限</li><li>安全存储敏感数据：使用KeyStore和加密API</li><li>安全通信：使用HTTPS和证书锁定</li><li>输入验证：验证所有外部输入</li><li>使用SafetyNet：检测设备完整性</li></ol><h3 id="系统开发安全指南" tabindex="-1"><a class="header-anchor" href="#系统开发安全指南"><span>系统开发安全指南</span></a></h3><ol><li>权限检查：每个敏感操作都需权限验证</li><li>SELinux策略：遵循最小权限原则</li><li>避免权限提升：谨慎使用<code>Binder.clearCallingIdentity()</code></li><li>安全IPC：验证所有IPC调用的来源</li><li>内存安全：使用内存安全语言或工具</li></ol><h2 id="结论" tabindex="-1"><a class="header-anchor" href="#结论"><span>结论</span></a></h2><p>Android的安全架构是一个多层次、深度防御的系统，从Linux内核到应用层都实施了严格的安全控制。了解这些安全机制不仅有助于开发更安全的应用，也有助于系统开发者实现更强大的安全特性。通过不断演进的安全模型，Android持续应对新的安全挑战，保护用户数据和隐私。</p><h2 id="参考资源" tabindex="-1"><a class="header-anchor" href="#参考资源"><span>参考资源</span></a></h2><ul><li><a href="https://source.android.com/security" target="_blank" rel="noopener noreferrer">Android安全与隐私文档</a></li><li><a href="https://developer.android.com/guide/topics/permissions/overview" target="_blank" rel="noopener noreferrer">Android权限系统概述</a></li><li><a href="https://source.android.com/security/selinux" target="_blank" rel="noopener noreferrer">SELinux for Android</a></li><li><a href="https://developer.android.com/training/articles/keystore" target="_blank" rel="noopener noreferrer">Android Keystore系统</a></li><li><a href="https://source.android.com/security/verifiedboot" target="_blank" rel="noopener noreferrer">验证启动</a></li></ul>`,78)])])}const r=i(e,[["render",h]]),k=JSON.parse('{"path":"/android/k2w93lx1/","title":"系统安全机制","lang":"zh-CN","frontmatter":{"title":"系统安全机制","createTime":"2025/04/29 14:32:19","permalink":"/android/k2w93lx1/"},"headers":[],"readingTime":{"minutes":6.1,"words":1829},"git":{"updatedTime":1745914733000,"contributors":[{"name":"Henry Thomas","username":"Henry Thomas","email":"henrythomas9587@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/Henry Thomas?v=4","url":"https://github.com/Henry Thomas"}]},"filePathRelative":"notes/android/framework/05/系统安全机制.md","bulletin":false}');export{r as comp,k as data};
